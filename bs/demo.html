<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>demo</title>
    <link rel="stylesheet" type="text/css" href="static/css/main.css">
    <link rel="stylesheet" type="text/css" href="static/css/demo.css">
    <link rel="stylesheet" type="text/css" href="static/css/zTreeStyle/zTreeStyle.css">
    <link rel="stylesheet" href="static/layui/css/layui.css"  media="all">
    <script src="static/js/jquery-1.4.4.min.js"></script>
    <script src="static/js/jquery.ztree.core.min.js"></script>
    <script src="static/js/echarts.min.js"></script>
    <script src="static/layui/layui.js"></script>
    <script src="static/js/require.js"></script>
    <script>
        // 配置加载模块
        require.config({
            paths: {
                "underscore": "static/js/underscore-min",
            }
        });
        require(['underscore'], function () {
            //
        });
    </script>
    <script>
        layui.use('laydate', function() {
            var laydate = layui.laydate;

            laydate.render({
                elem: '#from_time',
                type: 'datetime',
                format: 'yyyyMMddHHmmss'
            });

            laydate.render({
                elem: '#to_time',
                type: 'datetime',
                format: 'yyyyMMddHHmmss'
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            // 初始化隐藏ztree插件
            document.getElementById('treeDemo').style.display='none';
            // 初始化隐藏loading容器
            document.getElementById('loading-image').style.display='none';
            $.ajax({
                url: "/get_db_names",
                type: "POST",
                dataType: "json",
                success: function (data) {
                    var farm = document.getElementById('farm');
                    for (var i=0; i < data.length; i++) {
                        farm.options.add(new Option(data[i], i+1));
                    }
                }
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            // 必须使用#id进行选择才有效果
            $('#farm').change(function () {
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                if (treeObj) {
                    treeObj.destroy()
                }
                var farm_name = $('#farm').find('option:selected').text();
                $.ajax({
                	url: "/farm",
                	type: "POST",
                	data: {'farm_name': farm_name},
                	dataType: "json",
                	success: function (data) {
                	    var wind_turbine = document.getElementById('wind_turbine');
                	    // 默认使序号为0的项目选中
                	    wind_turbine.options[0].selected=true;
                	    var len = wind_turbine.options.length;
                	    // 默认清空已经存在的项目
                	    for (var n=1; n < len; n++) {
                	        wind_turbine.remove(1);
                        }
                        for (var i=0; i < data.length; i++) {
                            wind_turbine.options.add(new Option(data[i], i+1));
                        }
                	}
                });
            })
        });
    </script>
    <script>
        $(document).ready(function () {
            $("input[name=q]").click(function () {
                var farm_name = $('#farm').find('option:selected').text();
                var wind_turbine_name = $('#wind_turbine').find('option:selected').text();
                var from_time = $('#from_time').val();
                var to_time = $('#to_time').val();
                var from_rotate_speed = $('#from_rotate_speed').find('option:selected').text();
                var to_rotate_speed = $('#to_rotate_speed').find('option:selected').text();
                if (farm_name == '选择风场' || wind_turbine_name == '选择风机') {
                    alert('请先选择相应项目！');
                }
                else {
                    var dataset = {'farm_name': farm_name,
                        'wind_turbine_name': wind_turbine_name,
                        'from_time': from_time,
                        'to_time': to_time,
                        'from_rotate_speed': from_rotate_speed,
                        'to_rotate_speed': to_rotate_speed,
                    };
                    $.ajax({
                        url: "/q",
                        type: "POST",
                        data: dataset,
                        dataType: "json",
                        success: function (data) {
                            var zTreeObj;
                            var setting = {
                                callback: {
                                    onClick: zTreeOnClick
                                },
                                view: {
                                    showLine: false
                                }
                            };
                            var zNodes = [];
                            var child = [];
                            for (var key in data['point_description']) {
                                child.push({name:data['point_description'][key]});
                            }
                            for (var i=0; i < data['sampling_time'].length; i++) {
                                zNodes.push({name:data['sampling_time'][i], open:false, children:child})
                            }
                            function zTreeOnClick(event, treeId, treeNode) {
                                // console.log(treeNode.tId + ", " + treeNode.name);
                                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                                // 当前选中节点
                                var sn = treeObj.getSelectedNodes();
                                var html;
                                if (sn[0].hasOwnProperty('children') && sn[0].children.length > 0) {
                                    html = data['rotate_speed'][sn[0].name];
                                }
                                else {
                                    // 选中节点的父节点
                                    var pn = sn[0].getParentNode();
                                    html = data['rotate_speed'][pn.name];
                                }
                                document.getElementById('time_info').innerHTML = '转速：' + html;
                                // 显示time_info容器
                                document.getElementById('time_info').style.display='';
                            }
                            $(document).ready(function(){
                                zTreeObj = $.fn.zTree.init($("#treeDemo"), setting, zNodes);
                            });
                        }
                    });
                    // 显示ztree插件
                    document.getElementById('treeDemo').style.display='';
                }
            })
        });
    </script>
    <script>
        $(document).ready(function () {
            fig1 = echarts.init(document.getElementById('fig1'), 'white', {renderer: 'canvas'});
            fig2 = echarts.init(document.getElementById('fig2'), 'white', {renderer: 'canvas'});
            $("input[name=tf]").click(function () {
                var farm_name = $('#farm').find('option:selected').text();
                var wind_turbine_name = $('#wind_turbine').find('option:selected').text();
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                if (farm_name == '选择风场' || wind_turbine_name == '选择风机' || treeObj == null) {
                    alert('请先选择左侧项目！');
                }
                else {
                    // 当前选中节点
                    var sn = treeObj.getSelectedNodes();
                    if (sn.length == 0) {
                        alert('请选择测点！');
                    }
                    else if (sn[0].hasOwnProperty('children') && sn[0].children.length > 0) {
                        alert('请选择子节点！');
                    }
                    else {
                        // 选中节点的父节点
                        var pn = sn[0].getParentNode();
                        var dataset = {'farm_name': farm_name,
                            'wind_turbine_name': wind_turbine_name,
                            'sampling_time': pn['name'],
                            'point': sn[0]['name'],
                        };
                        $.ajax({
                            url: "/tf",
                            type: "POST",
                            data: dataset,
                            dataType: "json",
                            beforeSend: function () {
                                document.getElementById('loading-image').style.display='';
                                fig1.clear();
                                fig2.clear();
                            },
                            complete: function () {
                                // $('#loading-image').remove();
                                document.getElementById('loading-image').style.display='none';
                            },
                            success: function (data) {
                                var option_ts = {
                                    title: {
                                        text: '时域图'
                                    },
                                    tooltip: {
                                        trigger: 'axis',
                                        triggerOn: 'mousemove|click',
                                    },
                                    xAxis: {
                                        type: 'value',
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    yAxis: {
                                        type: 'value',
                                        boundaryGap: [0, '100%'],
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    series: [{
                                        name: '振动信号',
                                        type: 'line',
                                        showSymbol: false,
                                        hoverAnimation: false,
                                        data: data['time_series']
                                    }],
                                    dataZoom: [{
                                        //
                                    }],
                                    toolbox: { // 工具栏
                                        feature: {
                                            dataZoom: { // 框选缩放功能
                                                show: true, // show为true时，才能触发takeGlobalCursor事件
                                                yAxisIndex: 'none',
                                            },
                                            restore: {
                                                show: true
                                            },
                                            saveAsImage: {
                                                show: true,
                                                type: 'png',
                                            },
                                        }
                                    }
                                };
                                fig1.setOption(option_ts);
                                var option_freq = {
                                    title: {
                                        text: '频域图'
                                    },
                                    tooltip: {
                                        trigger: 'axis',
                                        triggerOn: 'none',
                                        // formatter : function (params) {
                                        //     console.log(params[0].value);
                                        // },
                                        // backgroundColor: "gray",
                                        position: function (point, params, dom, rect, size) {
                                            // 鼠标坐标和提示框位置的参考坐标系是：以外层div的左上角那一点为原点，x轴向右，y轴向下
                                            // 提示框位置
                                            var x = 0; // x坐标位置
                                            var y = 0; // y坐标位置

                                            // 当前鼠标位置
                                            var pointX = point[0];
                                            var pointY = point[1];

                                            // 外层div大小
                                            // var viewWidth = size.viewSize[0];
                                            // var viewHeight = size.viewSize[1];

                                            // 提示框大小
                                            var boxWidth = size.contentSize[0];
                                            var boxHeight = size.contentSize[1];

                                            // boxWidth > pointX 说明鼠标左边放不下提示框
                                            if (boxWidth > pointX) {
                                            x = 5;
                                            } else { // 左边放的下
                                            x = pointX;
                                            }

                                            // boxHeight > pointY 说明鼠标上边放不下提示框
                                            if (boxHeight > pointY) {
                                            y = 5;
                                            } else { // 上边放得下
                                            y = pointY;
                                            }

                                            return [x, y];
                                        },
                                    },
                                    xAxis: {
                                        type: 'value',
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    yAxis: {
                                        type: 'value',
                                        boundaryGap: [0, '100%'],
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    series: [{
                                        name: '振幅',
                                        type: 'line',
                                        showSymbol: false,
                                        hoverAnimation: true,
                                        data: data['freq']
                                    }],
                                    dataZoom: [{
                                        //
                                    }],
                                    toolbox: { // 工具栏
                                        feature: {
                                            dataZoom: { // 框选缩放功能
                                                show: true, // show为true时，才能触发takeGlobalCursor事件
                                                yAxisIndex: 'none',
                                            },
                                            restore: {
                                                show: true
                                            },
                                            saveAsImage: {
                                                show: true,
                                                type: 'png',
                                            },
                                        }
                                    }
                                };
                                fig2.setOption(option_freq);
                                fig2.getZr().on('click', function (params) {
                                    // console.log(params);
                                    let point = [params.offsetX, params.offsetY];
                                    if (fig2.containPixel({seriesIndex: 0}, point)) {
                                        let xIndex = fig2.convertFromPixel({seriesIndex: 0}, point)[0];
                                        let op = fig2.getOption();
                                        // console.log(op);
                                        let allxIndex = op.series[0].data.map((x) => x.value[0]);
                                        let diff = allxIndex.map((x) => Math.abs(x-xIndex));
                                        let closest = Math.min.apply(null, diff);
                                        let idx = diff.indexOf(closest);
                                        let name = op.series[0].data[idx].value[0];
                                        let value = op.series[0].data[idx].value[1];
                                        fig2.dispatchAction({
                                            type: 'showTip',
                                            seriesIndex: 0,//这行不能省
                                            dataIndex: idx
                                        });
                                        document.getElementById('time_info').innerHTML = name + ': ' + value;
                                    }
                                });
                            }
                        });
                    }
                }
            });
        });
	</script>
    <script>
        $(function () {
            let Btn = $("input[name=spectrum_envelope]");
            let Pop = $('#pop');
            let PopCon = $('.pop_con');

            Btn.click(function () {
                Pop.fadeIn();
                return false;
            });
            $(window).click(function () {
                Pop.fadeOut();
            });
            PopCon.click(function () {
                return false;
            });
            $('#envelope').click(function () {
                Pop.fadeOut();
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            fig3 = echarts.init(document.getElementById('fig3'), 'white', {renderer: 'canvas'});
            $("input[name=envelope]").click(function () {
                var farm_name = $('#farm').find('option:selected').text();
                var wind_turbine_name = $('#wind_turbine').find('option:selected').text();
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                var low_cutoff = $('#low_cutoff').val();
                var high_cutoff = $('#high_cutoff').val();
                if (farm_name == '选择风场' || wind_turbine_name == '选择风机' || treeObj == null) {
                    alert('请先选择左侧项目！');
                }
                else {
                    // 当前选中节点
                    var sn = treeObj.getSelectedNodes();
                    if (sn.length == 0) {
                        alert('请选择测点！');
                    }
                    else if (sn[0].hasOwnProperty('children') && sn[0].children.length > 0) {
                        alert('请选择子节点！');
                    }
                    else {
                        // 选中节点的父节点
                        var pn = sn[0].getParentNode();
                        var dataset = {'farm_name': farm_name,
                            'wind_turbine_name': wind_turbine_name,
                            'sampling_time': pn['name'],
                            'point': sn[0]['name'],
                            'low_cutoff': low_cutoff,
                            'high_cutoff': high_cutoff,
                        };
                        $.ajax({
                            url: "/envelope",
                            type: "POST",
                            data: dataset,
                            dataType: "json",
                            beforeSend: function () {
                                document.getElementById('loading-image').style.display='';
                                fig3.clear();
                            },
                            complete: function () {
                                document.getElementById('loading-image').style.display='none';
                            },
                            success: function (data) {
                                var option_envelope = {
                                    title: {
                                        text: '包络图'
                                    },
                                    tooltip: {
                                        trigger: 'axis',
                                        triggerOn: 'none',
                                        // formatter : function (params) {
                                        //     console.log(params[0].value);
                                        // },
                                        // backgroundColor: "gray",
                                        position: function (point, params, dom, rect, size) {
                                            // 鼠标坐标和提示框位置的参考坐标系是：以外层div的左上角那一点为原点，x轴向右，y轴向下
                                            // 提示框位置
                                            var x = 0; // x坐标位置
                                            var y = 0; // y坐标位置

                                            // 当前鼠标位置
                                            var pointX = point[0];
                                            var pointY = point[1];

                                            // 外层div大小
                                            // var viewWidth = size.viewSize[0];
                                            // var viewHeight = size.viewSize[1];

                                            // 提示框大小
                                            var boxWidth = size.contentSize[0];
                                            var boxHeight = size.contentSize[1];

                                            // boxWidth > pointX 说明鼠标左边放不下提示框
                                            if (boxWidth > pointX) {
                                            x = 5;
                                            } else { // 左边放的下
                                            x = pointX;
                                            }

                                            // boxHeight > pointY 说明鼠标上边放不下提示框
                                            if (boxHeight > pointY) {
                                            y = 5;
                                            } else { // 上边放得下
                                            y = pointY;
                                            }

                                            return [x, y];
                                        },
                                    },
                                    xAxis: {
                                        type: 'value',
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    yAxis: {
                                        type: 'value',
                                        boundaryGap: [0, '100%'],
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    series: [{
                                        name: '振幅',
                                        type: 'line',
                                        showSymbol: false,
                                        hoverAnimation: true,
                                        data: data['envelope']
                                    }],
                                    dataZoom: [{
                                        //
                                    }],
                                    toolbox: { // 工具栏
                                        feature: {
                                            dataZoom: { // 框选缩放功能
                                                show: true, // show为true时，才能触发takeGlobalCursor事件
                                                yAxisIndex: 'none',
                                            },
                                            restore: {
                                                show: true
                                            },
                                            saveAsImage: {
                                                show: true,
                                                type: 'png',
                                            },
                                        }
                                    }
                                };
                                fig3.setOption(option_envelope);
                                fig3.getZr().on('click', function (params) {
                                    // console.log(params);
                                    let point = [params.offsetX, params.offsetY];
                                    if (fig3.containPixel({seriesIndex: 0}, point)) {
                                        let xIndex = fig3.convertFromPixel({seriesIndex: 0}, point)[0];
                                        let op = fig3.getOption();
                                        // console.log(op);
                                        let allxIndex = op.series[0].data.map((x) => x.value[0]);
                                        let diff = allxIndex.map((x) => Math.abs(x-xIndex));
                                        let closest = Math.min.apply(null, diff);
                                        let idx = diff.indexOf(closest);
                                        let name = op.series[0].data[idx].value[0];
                                        let value = op.series[0].data[idx].value[1];
                                        fig3.dispatchAction({
                                            type: 'showTip',
                                            seriesIndex: 0,//这行不能省
                                            dataIndex: idx
                                        });
                                        document.getElementById('time_info').innerHTML = name + ': ' + value;
                                    }
                                });
                            }
                        });
                    }
                }
            });
        });
	</script>
    <script>
        $(document).ready(function () {
            var chartsArr = [];

            chartsArr.push(fig1);
            chartsArr.push(fig2);
            chartsArr.push(fig3);

            window.onresize = function () {
                for (var i = 0; i < chartsArr.length; i++) {
                    // ECharts随窗口大小改变而自适应
                    chartsArr[i].resize();
                }
            }
        });
    </script>
</head>
<body>
    <div class="left">
        <div class="logo"><img src="http://www.bj-nego.com/res/tpl/default/images/icon/logo.jpg"></div>
        <div class="query">
            <label for="farm"> 风 场 </label>
            <select id="farm" name="farm">
                <option value="0">选择风场</option>
            </select>
            <br/>
            <label for="wind_turbine" > 风 机 </label>
            <select id="wind_turbine" name="wind_turbine">
                <option value="0">选择风机</option>
            </select>
            <br/>
            <div class="layui-inline">
                <label class="layui-form-label">起始时间</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="from_time" placeholder="yyyyMMddHHmmss">
                </div>
            </div>
            <div class="layui-inline">
                <label class="layui-form-label">结束时间</label>
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" id="to_time" placeholder="yyyyMMddHHmmss">
                </div>
            </div>
            <br/>
            <label for="from_rotate_speed">转速 From</label>
            <select id="from_rotate_speed" name="from_rotate_speed">
                <option value="0">选择转速</option>
                <option value="1">1</option>
                <option value="1">2</option>
                <option value="1">3</option>
                <option value="1">4</option>
                <option value="1">5</option>
                <option value="1">6</option>
                <option value="1">7</option>
                <option value="1">8</option>
                <option value="1">9</option>
                <option value="1">10</option>
                <option value="1">11</option>
                <option value="1">12</option>
                <option value="1">13</option>
                <option value="1">14</option>
                <option value="1">15</option>
                <option value="1">16</option>
                <option value="1">17</option>
                <option value="1">18</option>
                <option value="1">19</option>
                <option value="1">20</option>
            </select>
            <br/>
            <label for="to_rotate_speed">转速 To</label>
            <select id="to_rotate_speed" name="to_rotate_speed">
                <option value="0">选择转速</option>
                <option value="1">1</option>
                <option value="1">2</option>
                <option value="1">3</option>
                <option value="1">4</option>
                <option value="1">5</option>
                <option value="1">6</option>
                <option value="1">7</option>
                <option value="1">8</option>
                <option value="1">9</option>
                <option value="1">10</option>
                <option value="1">11</option>
                <option value="1">12</option>
                <option value="1">13</option>
                <option value="1">14</option>
                <option value="1">15</option>
                <option value="1">16</option>
                <option value="1">17</option>
                <option value="1">18</option>
                <option value="1">19</option>
                <option value="1">20</option>
            </select>
            <br/>
            <input type="submit" value="查询" id="q" name="q">
        </div>
        <div id="time_info"></div>
        <div id="treeDemo" class="ztree">加载中...</div>
    </div>
    <div class="middle">
        <div class="toolbar">
            <input type="submit" value="时域图和频域图" id="toolbar1" name="tf">
            <input type="submit" value="频谱包络图" id="toolbar2" name="spectrum_envelope">
            <div id="pop" class="pop_main">
                <div class="pop_con">
                    <input type="text" id="low_cutoff" name="low_cutoff" placeholder="请输入低截止频率">
                    <input type="text" id="high_cutoff" name="high_cutoff" placeholder="请输入高截止频率">
                    <input type="submit" value="绘图" id="envelope" name="envelope">
                </div>
                <div class="mask"></div>
            </div>
        </div>
        <div class="figure">
            <div id="loading-image" class="loading">加载中...</div>
            <div id="fig1"></div>
            <div id="fig2"></div>
            <div id="fig3"></div>
        </div>
    </div>
    <div class="right">
        <div id="farm_info" class="info">风场信息</div>
        <div id="wind_turbine_info" class="info">风机信息</div>
        <div id="fault_history" class="info">故障历史</div>
    </div>
</body>
</html>